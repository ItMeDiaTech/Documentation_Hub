#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# ============================================================================
# Commit Message Hook: Conventional Commit Validation
# ============================================================================
# This hook enforces conventional commit format with AI-assisted validation
# Ensures team communication and changelog generation standards
#
# Supported Formats:
# - feat: new feature
# - fix: bug fix
# - docs: documentation
# - style: formatting
# - refactor: code restructuring
# - perf: performance improvement
# - test: testing
# - chore: maintenance
#
# Features:
# - Conventional commit validation
# - AI-assisted message improvement suggestions
# - Cross-platform compatibility
# - Integration with semantic versioning
# ============================================================================

COMMIT_MSG_FILE=$1

# Get workspace root
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]:-$0}")" && pwd)"
WORKSPACE_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

echo "üìù Commit Message Validation"
echo "Project: $(basename "$WORKSPACE_ROOT")"
echo "Timestamp: $(date '+%Y-%m-%d %H:%M:%S')"
echo "============================================="

# Read the commit message
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE" | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')

echo "Message: \"$COMMIT_MSG\""
echo ""

# Stage 1: Basic Format Validation
echo "üîç Stage 1: Format Validation"

validate_format() {
    # Allow merge commit messages
    if echo "$COMMIT_MSG" | grep -q "^Merge"; then
        echo "‚úÖ Merge commit detected - validation skipped"
        exit 0
    fi

    # Allow revert commit messages
    if echo "$COMMIT_MSG" | grep -q "^Revert"; then
        echo "‚úÖ Revert commit detected - validation skipped"
        exit 0
    fi

    # Check for conventional commit format
    if ! echo "$COMMIT_MSG" | grep -qE "^(feat|fix|docs|style|refactor|perf|test|chore|build|ci)(\([a-zA-Z0-9_-]+\))?!?:\s+.+"; then
        echo "‚ùå Invalid commit message format"
        echo ""
        echo "üí° Required format: type(scope)!: description"
        echo ""
        echo "üìö Valid Types:"
        echo "   ‚Ä¢ feat:     new feature for the user"
        echo "   ‚Ä¢ fix:      bug fix for the user"
        echo "   ‚Ä¢ docs:     changes to documentation"
        echo "   ‚Ä¢ style:    formatting, missing semicolons, etc."
        echo "   ‚Ä¢ refactor: code restructuring without functionality change"
        echo "   ‚Ä¢ perf:     performance improvements"
        echo "   ‚Ä¢ test:     adding or updating tests"
        echo "   ‚Ä¢ chore:    maintenance tasks"
        echo "   ‚Ä¢ build:    changes to build process"
        echo "   ‚Ä¢ ci:       changes to CI configuration"
        echo ""
        echo "üí° Examples:"
        echo "   ‚Ä¢ feat(user-auth): add login with email verification"
        echo "   ‚Ä¢ fix(api): resolve null pointer in user endpoint"
        echo "   ‚Ä¢ docs(readme): update installation instructions"
        echo "   ‚Ä¢ refactor(db): simplify query builders (BREAKING CHANGE)"
        echo ""
        echo "üí° For breaking changes, add '!' after scope or append 'BREAKING CHANGE:' in body"
        echo ""
        echo "üí° Use --no-verify to skip this check"
        exit 1
    fi

    echo "‚úÖ Commit message format is valid"
}

validate_format

# Stage 2: Content Quality Analysis
echo "ü§ñ Stage 2: AI-Assisted Content Analysis"

analyze_content() {
    CONTENT_ISSUES=()
    SUGGESTIONS=()

    # Extract commit type and scope
    COMMIT_TYPE=$(echo "$COMMIT_MSG" | sed -n 's/^\([a-zA-Z]*\)(.*/\1/p')
    COMMIT_SCOPE=$(echo "$COMMIT_MSG" | sed -n 's/^[a-zA-Z]*(\([^)]*\)).*/\1/p')
    COMMIT_DESC=$(echo "$COMMIT_MSG" | sed -n 's/^[a-zA-Z]*(.*): \(.*\)/\1/p')

    # Check description quality
    if [ ${#COMMIT_DESC} -lt 10 ]; then
        CONTENT_ISSUES+=("Commit description too short (< 10 characters)")
        SUGGESTIONS+=("Write more descriptive commit messages")
    fi

    if [ ${#COMMIT_DESC} -gt 100 ]; then
        CONTENT_ISSUES+=("Commit description too long (> 100 characters)")
        SUGGESTIONS+=("Keep descriptions concise and focused")
    fi

    # Check for imperative mood (starts with verb)
    if ! echo "$COMMIT_DESC" | grep -qE "^(add|update|fix|remove|refactor|improve|create|delete|modify|implement)"; then
        SUGGESTIONS+=("Consider starting description with an imperative verb")
    fi

    # Check for proper capitalization
    if echo "$COMMIT_DESC" | grep -q "^[A-Z]"; then
        CONTENT_ISSUES+=("Description should not start with capital letter")
        SUGGESTIONS+=("Use lowercase for commit descriptions")
    fi

    # Check for punctuation
    if echo "$COMMIT_DESC" | grep -q "[.!?]$"; then
        CONTENT_ISSUES+=("Description should not end with punctuation")
        SUGGESTIONS+=("Avoid ending descriptions with punctuation")
    fi

    # Check for AI-related improvements
    if echo "$COMMIT_MSG" | grep -qi "ai\|artificial\|intelligence\|gpt\|claude\|llm"; then
        if ! echo "$COMMIT_MSG" | grep -q "ü§ñ\|AI\|ai"; then
            SUGGESTIONS+=("Consider adding ü§ñ emoji for AI-related commits")
        fi
    fi

    # Check for security-related commits
    if echo "$COMMIT_DESC" | grep -qi "security\|auth\|password\|token\|secret"; then
        if [ "$COMMIT_TYPE" != "fix" ] && [ "$COMMIT_TYPE" != "feat" ]; then
            SUGGESTIONS+=("Security-related changes might use 'fix' or 'feat' type")
        fi
    fi

    if [ ${#CONTENT_ISSUES[@]} -ne 0 ]; then
        echo "‚ö†Ô∏è  Content quality issues detected:"
        printf '   ‚Ä¢ %s\n' "${CONTENT_ISSUES[@]}"
        echo ""
    fi

    if [ ${#SUGGESTIONS[@]} -ne 0 ]; then
        echo "üí° AI suggestions for improvement:"
        printf '   ‚Ä¢ %s\n' "${SUGGESTIONS[@]}"
        echo ""
    fi

    # Don't block on suggestions, only on critical issues
    if [ ${#CONTENT_ISSUES[@]} -eq 0 ]; then
        echo "‚úÖ Content quality analysis passed"
    else
        echo "‚ùå Critical content issues detected"
        echo "üí° Fix issues or use --no-verify to skip"
        exit 1
    fi
}

analyze_content

# Stage 3: Semantic Version Impact Analysis
echo "üìä Stage 3: Version Impact Analysis"

analyze_versioning() {
    VERSION_IMPACT=""

    # Determine version bump type
    case "$COMMIT_TYPE" in
        feat)
            if echo "$COMMIT_MSG" | grep -q "!"; then
                VERSION_IMPACT="üö® BREAKING CHANGE - Major version bump required"
            else
                VERSION_IMPACT="‚ú® New feature - Minor version bump"
            fi
            ;;
        fix)
            if echo "$COMMIT_MSG" | grep -q "!"; then
                VERSION_IMPACT="üö® BREAKING FIX - Major version bump required"
            else
                VERSION_IMPACT="üêõ Bug fix - Patch version bump"
            fi
            ;;
        perf)
            VERSION_IMPACT="‚ö° Performance improvement - Minor version bump"
            ;;
        refactor|style|test|docs|chore|build|ci)
            VERSION_IMPACT="üîß Maintenance - No version bump"
            ;;
        *)
            VERSION_IMPACT="ü§î Custom type - Manual version review needed"
            ;;
    esac

    echo "üìã Version Impact: $VERSION_IMPACT"
    echo "‚úÖ Semantic versioning analysis completed"
}

analyze_versioning

# Validation Complete
echo "============================================="
echo "‚úÖ Commit message validation completed successfully!"
echo ""
echo "üéØ Your commit follows conventional standards"
echo ""
echo "üìä Commit Analysis Summary:"
echo "   ‚Ä¢ Format: ‚úÖ Valid"
echo "   ‚Ä¢ Content: ‚úÖ Quality Checked"
echo "   ‚Ä¢ Versioning: ‚úÖ Analyzed"
echo "============================================="

exit 0
