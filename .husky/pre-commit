#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# ============================================================================
# Pre-Commit Hook: Validate Electron Security Settings
# ============================================================================
# This hook prevents commits that would compromise Electron security or
# cause the dreaded "black screen" issue in production.
#
# Protected settings in electron/main.ts:
# - nodeIntegration MUST be false (security)
# - contextIsolation MUST be true (required for React)
#
# Why this matters:
# - Historical incidents: 159f47b, 290ee59, 7575ba6 (black screen issues)
# - Prevents accidental security vulnerabilities
# - Catches configuration errors before they reach CI/CD
#
# To bypass (NOT RECOMMENDED):
# git commit --no-verify
# ============================================================================

echo "🔒 Validating Electron security settings..."

# Check if electron/main.ts is being committed
if git diff --cached --name-only | grep -q "electron/main.ts"; then
  echo "   → Checking electron/main.ts for security violations..."

  # Check for nodeIntegration: true (SECURITY VIOLATION)
  # Look for actual code (not comments) with nodeIntegration: true
  if git diff --cached electron/main.ts | grep -E "^\+\s+nodeIntegration:\s*true" | grep -v "^\+\s*//" | grep -v "^\+\s*\*" > /dev/null; then
    echo ""
    echo "╔════════════════════════════════════════════════════════════════════════════╗"
    echo "║                     ❌ COMMIT BLOCKED - SECURITY VIOLATION                 ║"
    echo "╠════════════════════════════════════════════════════════════════════════════╣"
    echo "║                                                                            ║"
    echo "║  You are attempting to commit 'nodeIntegration: true'                     ║"
    echo "║                                                                            ║"
    echo "║  This is a CRITICAL security vulnerability that:                          ║"
    echo "║  - Allows XSS attacks to access Node.js APIs                              ║"
    echo "║  - Exposes filesystem and system resources to web content                 ║"
    echo "║  - Violates Electron security best practices                              ║"
    echo "║                                                                            ║"
    echo "║  Required setting: nodeIntegration: false                                 ║"
    echo "║  Location: electron/main.ts (REQUIRED_SECURITY_SETTINGS)                  ║"
    echo "║                                                                            ║"
    echo "║  To expose APIs safely:                                                   ║"
    echo "║  → Use contextBridge in electron/preload.ts                               ║"
    echo "║  → See: https://www.electronjs.org/docs/latest/tutorial/security         ║"
    echo "║                                                                            ║"
    echo "╚════════════════════════════════════════════════════════════════════════════╝"
    echo ""
    exit 1
  fi

  # Check for contextIsolation: false (CAUSES BLACK SCREEN)
  # Look for actual code (not comments) with contextIsolation: false
  if git diff --cached electron/main.ts | grep -E "^\+\s+contextIsolation:\s*false" | grep -v "^\+\s*//" | grep -v "^\+\s*\*" > /dev/null; then
    echo ""
    echo "╔════════════════════════════════════════════════════════════════════════════╗"
    echo "║                     ❌ COMMIT BLOCKED - BLACK SCREEN DETECTED              ║"
    echo "╠════════════════════════════════════════════════════════════════════════════╣"
    echo "║                                                                            ║"
    echo "║  You are attempting to commit 'contextIsolation: false'                   ║"
    echo "║                                                                            ║"
    echo "║  This will cause a BLACK SCREEN in production because:                    ║"
    echo "║  - React lazy loading will fail                                           ║"
    echo "║  - Context providers won't work (Theme, Router, etc.)                     ║"
    echo "║  - Dynamic imports will break                                             ║"
    echo "║                                                                            ║"
    echo "║  Required setting: contextIsolation: true                                 ║"
    echo "║  Location: electron/main.ts (REQUIRED_SECURITY_SETTINGS)                  ║"
    echo "║                                                                            ║"
    echo "║  Historical black screen incidents:                                       ║"
    echo "║  - 2025-10-17: Commit 159f47b                                             ║"
    echo "║  - 2025-10-16: Commit 290ee59                                             ║"
    echo "║  - 2024-12-xx: Commit 7575ba6                                             ║"
    echo "║                                                                            ║"
    echo "║  DO NOT change this setting!                                              ║"
    echo "║                                                                            ║"
    echo "╚════════════════════════════════════════════════════════════════════════════╝"
    echo ""
    exit 1
  fi

  # Check if someone removed the const assertion
  if git diff --cached electron/main.ts | grep -E "^\-.*REQUIRED_SECURITY_SETTINGS" > /dev/null; then
    echo ""
    echo "╔════════════════════════════════════════════════════════════════════════════╗"
    echo "║                     ⚠️  WARNING - SECURITY PROTECTION REMOVED              ║"
    echo "╠════════════════════════════════════════════════════════════════════════════╣"
    echo "║                                                                            ║"
    echo "║  You are removing REQUIRED_SECURITY_SETTINGS constant.                    ║"
    echo "║                                                                            ║"
    echo "║  This constant protects against:                                          ║"
    echo "║  - Accidental security misconfigurations                                  ║"
    echo "║  - Black screen bugs in production                                        ║"
    echo "║  - TypeScript type errors                                                 ║"
    echo "║                                                                            ║"
    echo "║  Are you SURE you want to do this?                                        ║"
    echo "║  This protection was added after multiple production incidents.           ║"
    echo "║                                                                            ║"
    echo "╚════════════════════════════════════════════════════════════════════════════╝"
    echo ""
    # Don't block, just warn
  fi

  echo "   ✅ Security validation passed!"
else
  echo "   → electron/main.ts not modified, skipping validation"
fi

echo "✅ Pre-commit checks complete!"
