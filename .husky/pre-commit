#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# ============================================================================
# Pre-Commit Hook: Validate Electron Security Settings
# ============================================================================
# This hook prevents commits that would compromise Electron security or
# cause the dreaded "black screen" issue in production.
#
# Protected settings in electron/main.ts:
# - nodeIntegration MUST be false (security)
# - contextIsolation MUST be true (required for React)
#
# Why this matters:
# - Historical incidents: 159f47b, 290ee59, 7575ba6 (black screen issues)
# - Prevents accidental security vulnerabilities
# - Catches configuration errors before they reach CI/CD
#
# To bypass (NOT RECOMMENDED):
# git commit --no-verify
# ============================================================================

echo "ğŸ”’ Validating Electron security settings..."

# Check if electron/main.ts is being committed
if git diff --cached --name-only | grep -q "electron/main.ts"; then
  echo "   â†’ Checking electron/main.ts for security violations..."

  # Check for nodeIntegration: true (SECURITY VIOLATION)
  # Look for actual code (not comments) with nodeIntegration: true
  if git diff --cached electron/main.ts | grep -E "^\+\s+nodeIntegration:\s*true" | grep -v "^\+\s*//" | grep -v "^\+\s*\*" > /dev/null; then
    echo ""
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘                     âŒ COMMIT BLOCKED - SECURITY VIOLATION                 â•‘"
    echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
    echo "â•‘                                                                            â•‘"
    echo "â•‘  You are attempting to commit 'nodeIntegration: true'                     â•‘"
    echo "â•‘                                                                            â•‘"
    echo "â•‘  This is a CRITICAL security vulnerability that:                          â•‘"
    echo "â•‘  - Allows XSS attacks to access Node.js APIs                              â•‘"
    echo "â•‘  - Exposes filesystem and system resources to web content                 â•‘"
    echo "â•‘  - Violates Electron security best practices                              â•‘"
    echo "â•‘                                                                            â•‘"
    echo "â•‘  Required setting: nodeIntegration: false                                 â•‘"
    echo "â•‘  Location: electron/main.ts (REQUIRED_SECURITY_SETTINGS)                  â•‘"
    echo "â•‘                                                                            â•‘"
    echo "â•‘  To expose APIs safely:                                                   â•‘"
    echo "â•‘  â†’ Use contextBridge in electron/preload.ts                               â•‘"
    echo "â•‘  â†’ See: https://www.electronjs.org/docs/latest/tutorial/security         â•‘"
    echo "â•‘                                                                            â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    exit 1
  fi

  # Check for contextIsolation: false (CAUSES BLACK SCREEN)
  # Look for actual code (not comments) with contextIsolation: false
  if git diff --cached electron/main.ts | grep -E "^\+\s+contextIsolation:\s*false" | grep -v "^\+\s*//" | grep -v "^\+\s*\*" > /dev/null; then
    echo ""
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘                     âŒ COMMIT BLOCKED - BLACK SCREEN DETECTED              â•‘"
    echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
    echo "â•‘                                                                            â•‘"
    echo "â•‘  You are attempting to commit 'contextIsolation: false'                   â•‘"
    echo "â•‘                                                                            â•‘"
    echo "â•‘  This will cause a BLACK SCREEN in production because:                    â•‘"
    echo "â•‘  - React lazy loading will fail                                           â•‘"
    echo "â•‘  - Context providers won't work (Theme, Router, etc.)                     â•‘"
    echo "â•‘  - Dynamic imports will break                                             â•‘"
    echo "â•‘                                                                            â•‘"
    echo "â•‘  Required setting: contextIsolation: true                                 â•‘"
    echo "â•‘  Location: electron/main.ts (REQUIRED_SECURITY_SETTINGS)                  â•‘"
    echo "â•‘                                                                            â•‘"
    echo "â•‘  Historical black screen incidents:                                       â•‘"
    echo "â•‘  - 2025-10-17: Commit 159f47b                                             â•‘"
    echo "â•‘  - 2025-10-16: Commit 290ee59                                             â•‘"
    echo "â•‘  - 2024-12-xx: Commit 7575ba6                                             â•‘"
    echo "â•‘                                                                            â•‘"
    echo "â•‘  DO NOT change this setting!                                              â•‘"
    echo "â•‘                                                                            â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    exit 1
  fi

  # Check if someone removed the const assertion
  if git diff --cached electron/main.ts | grep -E "^\-.*REQUIRED_SECURITY_SETTINGS" > /dev/null; then
    echo ""
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘                     âš ï¸  WARNING - SECURITY PROTECTION REMOVED              â•‘"
    echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
    echo "â•‘                                                                            â•‘"
    echo "â•‘  You are removing REQUIRED_SECURITY_SETTINGS constant.                    â•‘"
    echo "â•‘                                                                            â•‘"
    echo "â•‘  This constant protects against:                                          â•‘"
    echo "â•‘  - Accidental security misconfigurations                                  â•‘"
    echo "â•‘  - Black screen bugs in production                                        â•‘"
    echo "â•‘  - TypeScript type errors                                                 â•‘"
    echo "â•‘                                                                            â•‘"
    echo "â•‘  Are you SURE you want to do this?                                        â•‘"
    echo "â•‘  This protection was added after multiple production incidents.           â•‘"
    echo "â•‘                                                                            â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    # Don't block, just warn
  fi

  echo "   âœ… Security validation passed!"
else
  echo "   â†’ electron/main.ts not modified, skipping validation"
fi

echo "âœ… Pre-commit checks complete!"
